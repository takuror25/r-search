<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>【非公式】れいわ街宣・おしゃべり会検索</title>
<style>
body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
a { text-decoration: none; color: #0366d6; }
.highlight { background: yellow; }
</style>
</head>
<body>

<h1>【非公式】れいわ街宣・おしゃべり会検索</h1>

<input id="search" type="text" placeholder="キーワード検索（例：消費税）" style="width:100%; padding:0.5em; margin-bottom:1em;">

<h2>各回の一覧</h2>
<ul id="list">
  <li><a href="talks/2025-09-03-wakkanai.txt">2025-09-03 稚内</a></li>
</ul>

<hr>

<div id="results"></div>


<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
const files = [
  "talks/2025-09-03-wakkanai.txt",
  "talks/2025-09-06-ieamisawa.txt",

];

let data = [];

async function loadFiles() {
  for (const file of files) {
    try {
      const res = await fetch(file);
      if (!res.ok) throw new Error(`読み込み失敗: ${file}`);
      const text = await res.text();
      data.push({
        title: file.split('/')[1].replace('.txt',''),
        text: text,
        url: file
      });
    } catch(e) {
      console.error(e);
    }
  }
  console.log("読み込み完了:", data.length, "件");
}

loadFiles().then(() => {
  console.log("Fuse.js 検索準備OK");

  const fuse = new Fuse(data, {
    includeScore: true,
    keys: ['text'],
    threshold: 0.3,
    tokenize: true,
    minMatchCharLength: 1
  });

  const input = document.getElementById('query');
  const resultDiv = document.getElementById('results');

  input.addEventListener('input', e => {
    const q = e.target.value.trim();
    resultDiv.innerHTML = '';
    if (!q) return;

    const results = fuse.search(q);
    console.log("検索結果:", results.length);

    results.forEach(res => {
      const text = res.item.text;
      const re = new RegExp(q, 'g');
      const matches = [...text.matchAll(re)];
      matches.forEach(m => {
        const i = m.index;
        const snippet = text.slice(Math.max(0, i - 60), i + q.length + 60);
        const safeSnippet = snippet.replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const highlighted = safeSnippet.replace(new RegExp(q,'g'), `<mark>${q}</mark>`);
        resultDiv.innerHTML += `
          <div class="result">
            <strong>${res.item.title}</strong>
            <a href="${res.item.url}" target="_blank">（全文）</a>
            <span class="snippet">…${highlighted}…</span>
          </div>`;
      });
    });
  });
});
</script>
  
</body>
</html>
