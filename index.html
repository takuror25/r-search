<script>
const files = [
  "talks/2025-09-03-wakkanai.txt",
  "talks/2025-09-12-kushiro.txt",
  "talks/2025-09-18-obihiro.txt"
];

let data = [];

async function loadFiles() {
  for (const file of files) {
    try {
      const res = await fetch(file);
      if (!res.ok) throw new Error(`読み込み失敗: ${file}`);
      const text = await res.text();
      data.push({
        title: file.split('/')[1].replace('.txt',''),
        text: text,
        url: file
      });
    } catch(e) {
      console.error(e);
    }
  }
  console.log("読み込み完了:", data.length, "件");
}

loadFiles().then(() => {
  console.log("Fuse.js 検索準備OK");

  const fuse = new Fuse(data, {
    includeScore: true,
    keys: ['text'],
    threshold: 0.3,
    tokenize: true,
    minMatchCharLength: 1
  });

  const input = document.getElementById('query');
  const resultDiv = document.getElementById('results');

  input.addEventListener('input', e => {
    const q = e.target.value.trim();
    resultDiv.innerHTML = '';
    if (!q) return;

    const results = fuse.search(q);
    console.log("検索結果:", results.length);

    results.forEach(res => {
      const text = res.item.text;
      const re = new RegExp(q, 'g');
      const matches = [...text.matchAll(re)];
      matches.forEach(m => {
        const i = m.index;
        const snippet = text.slice(Math.max(0, i - 60), i + q.length + 60);
        const safeSnippet = snippet.replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const highlighted = safeSnippet.replace(new RegExp(q,'g'), `<mark>${q}</mark>`);
        resultDiv.innerHTML += `
          <div class="result">
            <strong>${res.item.title}</strong>
            <a href="${res.item.url}" target="_blank">（全文）</a>
            <span class="snippet">…${highlighted}…</span>
          </div>`;
      });
    });
  });
});
</script>
