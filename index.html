<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>れいわ新選組街宣・おしゃべり会検索（非公式）</title>

<style>
  body { font-family: sans-serif; margin: 2em; line-height: 1.6; }
  input#search {
    width: 100%;
    padding: 20px 16px;
    font-size: 1.1em;
    border: 2px solid #888;
    border-radius: 12px;
    box-sizing: border-box;
    outline: none;
    transition: all 0.2s ease;
  }
  input#search:focus {
    border-color: #e4007e;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
  }
  .result { margin: 1em 0; cursor: pointer; border-bottom: 1px solid #ccc; padding: 0.5em 0; }
  /* #viewer スタイルは不要なので削除 */
  #note { color: #555; font-size: 0.95em; margin-top: 1em; background: #f6f6f6; padding: 0.8em; border-radius: 8px; }
  .hidden { display: none !important; }

 .y { color: #222222; }
 .q { color: #E91E63; }
 .r { color: #6A1B9A; }
 .v { color: #AD1457; }

 /* .time スタイルは検索結果内では不要なので削除 (ハイライトで十分) */

 .highlight {
  background-color: #FFCCE5;
  font-weight: bold;
 }

 /* --- ページの先頭に戻るボタン --- */
 #backToTopButton {
  position: fixed; bottom: 20px; right: 20px;
  width: 50px; height: 50px; background-color: #e4007e; color: white;
  border: 2px solid white; border-radius: 50%;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 9990; opacity: 0;
  transform: translateY(20px); pointer-events: none;
  transition: opacity 0.3s, transform 0.3s;
 }
 #backToTopButton.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
 #backToTopButton:hover { background-color: #c3006a; }
 #backToTopButton svg { width: 28px; height: 28px; fill: white; }

 /* --- ポップアッププレイヤー --- */
 #popupPlayer {
  visibility: hidden; /* display:noneではなくvisibilityで管理 */
  position: fixed;
  bottom: 10px;
  left: 10px;
  transform: none; /* 初期位置は固定、ドラッグでtransform変更 */
  width: calc(100vw - 90px); /* 画面幅 - 右ボタン等のマージン */
  max-width: 400px; /* PCでの最大幅 */
  background: #000;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  touch-action: none; /* スマホドラッグ用 */
 }
 #dragHandle {
  height: 24px; background: #333; cursor: grab;
  border-top-left-radius: 10px; border-top-right-radius: 10px;
  position: relative;
 }
 #dragHandle .grip { /* つまみの見た目 */
  width: 40px; height: 4px; background: #666;
  border-radius: 2px; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
 }
 #playerContainer {
  position: relative; width: 100%;
  padding-top: 56.25%; /* 16:9 Aspect Ratio */
 }
 #playerContainer iframe {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%; border: none;
 }
 #closePlayer { /* 閉じるボタン */
  background: #e53935; color: white; border: none;
  font-size: 1.2em; font-weight: bold;
  cursor: pointer; position: absolute; top: -10px; right: -10px;
  width: 24px; height: 24px; border-radius: 50%;
  z-index: 10000; /* 最前面 */
  display: flex; align-items: center; justify-content: center;
 }
</style>
</head>

<body>

<h1>れいわ新選組街宣・おしゃべり会検索（非公式）</h1>
<p>れいわ新選組の街宣・おしゃべり会の中からキーワードで検索するツールです。<br>
  ※AIを使用して文字化しているため、文章は誤字や不正確な点が発生します。<br>
  ※正確な情報源としては、れいわ新選組の公式YouTubeをご確認ください。 </p>
<input type="text" id="search" placeholder="キーワードを入力">
<div id="results"></div>

<div id="popupPlayer" style="visibility: hidden;">
  <div id="dragHandle"><div class="grip"></div></div>
  <button id="closePlayer">×</button>
  <div id="playerContainer"></div>
</div>

<script src="data/files.js?v=3"></script>
<script>
// --- グローバル変数と初期設定 ---
const backToTopButton = document.createElement('button');
const popup = document.getElementById("popupPlayer");
const dragHandle = document.getElementById("dragHandle");
const closePlayerBtn = document.getElementById("closePlayer");
const playerContainer = document.getElementById("playerContainer");

let active = false;
let currentX; let currentY; let initialX; let initialY;
let xOffset = 0; let yOffset = 0;

// --- 関数定義 ---

// YouTubeプレイヤーを表示・再生する関数
const playVideoAtTime = (videoId, seconds) => {
  const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&start=${seconds}`;
  playerContainer.innerHTML = `<iframe src="${embedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
  popup.style.visibility = 'visible';
};

// ドラッグ開始
const dragStart = (e) => {
  let evt = e.type === 'touchstart' ? e.touches[0] : e;
  initialX = evt.clientX - xOffset;
  initialY = evt.clientY - yOffset;
  // ドラッグハンドルの要素、またはその子要素(grip)がタッチ/クリックされた場合のみ有効
  if (e.target === dragHandle || dragHandle.contains(e.target)) {
    active = true;
    dragHandle.style.cursor = 'grabbing'; // カーソル変更
  }
};

// ドラッグ終了
const dragEnd = () => {
  if (active) { // ドラッグ中だった場合のみ
    active = false;
    dragHandle.style.cursor = 'grab'; // カーソル戻す
  }
};

// ドラッグ中
const drag = (e) => {
  if (active) {
    e.preventDefault();
    let evt = e.type === 'touchmove' ? e.touches[0] : e;
    currentX = evt.clientX - initialX;
    currentY = evt.clientY - initialY;
    xOffset = currentX;
    yOffset = currentY;
    popup.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
  }
};

// --- イベントリスナーの設定 ---

// 先頭に戻るボタン
backToTopButton.id = 'backToTopButton';
backToTopButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>`;
document.body.appendChild(backToTopButton);
backToTopButton.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
window.addEventListener('scroll', () => {
  backToTopButton.classList.toggle('visible', window.scrollY > 200);
});

// 検索入力
document.getElementById("search").addEventListener("input", async (e) => {
  const query = e.target.value.trim();
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  popup.style.visibility = 'hidden'; // 検索し直したらプレイヤーを隠す
  playerContainer.innerHTML = "";

  if (!query) return;

  const keywords = query.split(/\s+/).filter(k => k);
  if (keywords.length === 0) return;
  
  const results = [];

  for (const f of files) {
    try {
      const res = await fetch(f.url);
      if (!res.ok) continue;
      const text = await res.text();

      // <p>タグを抽出して配列にする
      const paragraphs = text.split(/(<p>.*?<\/p>)/s).filter(p => p.startsWith('<p>'));
      
      paragraphs.forEach((pHTML, index) => {
        const plainText = pHTML.replace(/<[^>]*>/g, "");
        // AND検索: すべてのキーワードを含むか
        if (keywords.every(k => plainText.toLowerCase().includes(k.toLowerCase()))) {
          // 最初のタイムスタンプを抽出 (HH:MM:SS形式)
          const timeMatch = plainText.match(/^(\d{2}:\d{2}:\d{2})/);
          if (timeMatch) {
            results.push({
              title: f.title,
              video: f.video,
              pHTML: pHTML, // 表示とハイライト用にHTMLを保持
              timestamp: timeMatch[1], // 時間文字列 HH:MM:SS
            });
          }
        }
      });
    } catch (err) {
      console.error("読み込み失敗:", f.url, err);
    }
  }

  if (results.length === 0) {
    resultsDiv.innerHTML = "<p>一致する結果はありません。</p>";
    return;
  }

  const note = document.createElement("div");
  note.id = "note";
  note.innerHTML = `
    <strong>結果の見方：</strong><br>
    検索したワードを含む部分を一覧で表示します。<br>
    一覧の中からどれかをクリックすると該当箇所の動画を再生できます。<br>
    ※AIを使用して文字化しているため、文章は誤字や不正確な点が発生します。<br>
    ※正確な情報源としてはYouTubeをご確認ください。<br>
    ※動画に広告が表示されますがYouTube側の仕様であり、収益目的ではありません。
  `;
  resultsDiv.appendChild(note);

  results.forEach(r => {
    let highlightedHTML = r.pHTML;
    // 結果表示用にキーワードをハイライト
    for (const k of keywords) {
      const escaped = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      // (?![^<]*>) を使ってタグの中身は置換しないようにする
      highlightedHTML = highlightedHTML.replace(new RegExp(`(${escaped})(?![^<]*>)`, "gi"), `<span class="highlight">$1</span>`);
    }

    const div = document.createElement("div");
    div.className = "result";
    // ハイライトされたHTMLを表示
    div.innerHTML = `<strong>${r.title}</strong><br>${highlightedHTML}`;
    
    // クリックしたら動画再生関数を呼び出す
    div.addEventListener("click", () => {
        const videoId = r.video.split("v=")[1]?.split("&")[0] || r.video.split("/").pop();
        const [h, m, s] = r.timestamp.split(":").map(Number);
        const seconds = h * 3600 + m * 60 + s;
        playVideoAtTime(videoId, seconds);
    });
    resultsDiv.appendChild(div);
  });
});

// ドラッグイベントリスナー (ページ読み込み時に一度だけ設定)
dragHandle.addEventListener("touchstart", dragStart, { passive: false });
document.addEventListener("touchend", dragEnd, { passive: false }); // document全体で離したのを検知
document.addEventListener("touchmove", drag, { passive: false }); // document全体で動かすのを検知
dragHandle.addEventListener("mousedown", dragStart, { passive: false });
document.addEventListener("mouseup", dragEnd, { passive: false });
document.addEventListener("mousemove", drag, { passive: false });

// 閉じるボタン (ページ読み込み時に一度だけ設定)
closePlayerBtn.addEventListener("click", () => {
  popup.style.visibility = 'hidden';
  playerContainer.innerHTML = "";
  // ドラッグ位置をリセット (必要なら)
  // xOffset = 0; yOffset = 0;
  // popup.style.transform = `translate3d(0px, 0px, 0)`; 
});

</script>
  
</body>

</html>
